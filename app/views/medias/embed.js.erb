/*jslint nomen: true, plusplus: true, todo: true, white: true, browser: true, indent: 2 */

// This happens on the parent window

(function() {
  'use strict';

  var scripts = document.getElementsByTagName('SCRIPT'),
      url = '<%= @url %>';

  for (var i = 0; i < scripts.length; i++) {
    if (scripts[i].getAttribute('src') == '<%= @caller %>') {
      var css = scripts[i].getAttribute('data-custom-css');
      if (css) {
        url += '#css=' + css;
      }
    }
  }

  var frame = '<iframe src="' + url + '" width="100%" frameborder="0" scrolling="no" id="bridge-embed-iframe-<%= @id %>" seamless>' +
              'Your browser does not support iframes' +
              '</iframe>';
  document.write(frame);

  var messageCallback = function(e) {
    var data   = e.data.split(';'),
        type   = data[0];

    switch (type) {
      // Height changed
      case 'setHeight':
        var title = data[1],
            height = data[2],
            iframe = document.getElementById('bridge-embed-iframe-' + title);
        if (iframe != undefined) iframe.style.height = height + 'px';
        break;
    }
  };

  var isVisible = function(el) {
    return (el.offsetHeight > 0 || el.offsetWidth > 0 || el.offsetTop > 0 || el.offsetLeft > 0);
  };

  var resizeOrScrollCallback = function(e) {
    var frame = document.getElementById('bridge-embed-iframe-<%= @id %>'),
        f = frame.getBoundingClientRect(),
        h = window.innerHeight || document.documentElement.clientHeight,
        w = window.innerWidth || document.documentElement.clientWidth;
    if (isVisible(frame)) frame.contentWindow.postMessage(['lazyLoad', h, w, f.top, f.left, f.bottom, f.right].join(';'), '*');
  };

  // If the embed is not visible, watch for its visiblity
  var frameVisible = false;
  var checkFrameVisibility = function() {
    var frame = document.getElementById('bridge-embed-iframe-<%= @id %>');
    if (frame) {
      var visible = isVisible(frame);
      if (visible != frameVisible) {
        frameVisible = visible;
        resizeOrScrollCallback();
      }
    }
    setTimeout(checkFrameVisibility, 100);
  };
  checkFrameVisibility();

  if (!window.addEventListener) {
    window.attachEvent('onmessage', messageCallback);
    window.attachEvent('onscroll', resizeOrScrollCallback);
    window.attachEvent('onresize', resizeOrScrollCallback);
    window.attachEvent('onload', resizeOrScrollCallback);
  }
  else {
    window.addEventListener('message', messageCallback, false);
    window.addEventListener('scroll', resizeOrScrollCallback, false);
    window.addEventListener('resize', resizeOrScrollCallback, false);
    window.addEventListener('load', resizeOrScrollCallback, false);
  }
}());
