<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Bridgembed</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.0/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.0/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.0/favicon_green.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.0/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.0/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2015-09-21T04:44:15-03:00">2015-09-21T04:44:15-03:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         28.71
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>12</b> files in total.
    <b>575</b> relevant lines. 
    <span class="green"><b>575</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#35abb7809ebeab7c0388667115bbe464c4b25d60" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>22</td>
        <td>8</td>
        <td>8</td>
        <td>0</td>
        <td>2.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6a39daa1be193c23afc6d0591edd8e8114a8c118" class="src_link" title="app/controllers/medias_controller.rb">app/controllers/medias_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>124</td>
        <td>76</td>
        <td>76</td>
        <td>0</td>
        <td>12.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#255d8734f1b7ebd54e643d07715d4e7a73386401" class="src_link" title="app/helpers/medias_helper.rb">app/helpers/medias_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>77</td>
        <td>47</td>
        <td>47</td>
        <td>0</td>
        <td>71.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e5c28d29e9d76faaa90ea5ff4bf9a47c7022d926" class="src_link" title="app/sources/base.rb">app/sources/base.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>77</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>16.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f94fb6ca82c3cdeae4b84916101736582bdc4b0c" class="src_link" title="app/sources/bridge_api.rb">app/sources/bridge_api.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>141</td>
        <td>73</td>
        <td>73</td>
        <td>0</td>
        <td>6.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#74a23a080a359d28269564b7aab69cb5aa3da9bd" class="src_link" title="app/sources/google_spreadsheet.rb">app/sources/google_spreadsheet.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>209</td>
        <td>110</td>
        <td>110</td>
        <td>0</td>
        <td>33.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#edb00029fef603b122b883fe21c263cfafb2888c" class="src_link" title="lib/bridge_cache.rb">lib/bridge_cache.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>155</td>
        <td>97</td>
        <td>97</td>
        <td>0</td>
        <td>33.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#609981825ce762ec9d5ac35293e1bda21bcdf1ad" class="src_link" title="lib/bridge_cc_deville.rb">lib/bridge_cc_deville.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>35</td>
        <td>21</td>
        <td>21</td>
        <td>0</td>
        <td>44.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8e3e4bf48032d2f0357011e60b97e48eb680fe26" class="src_link" title="lib/bridge_embedly.rb">lib/bridge_embedly.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>114</td>
        <td>72</td>
        <td>72</td>
        <td>0</td>
        <td>38.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#355c824cd93e6e09a323c34f340a7ece563928ae" class="src_link" title="lib/bridge_error_codes.rb">lib/bridge_error_codes.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#68f4895821170a6fa9875b5ab313e46f4662bb99" class="src_link" title="lib/bridge_google_authentication.rb">lib/bridge_google_authentication.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>43</td>
        <td>24</td>
        <td>24</td>
        <td>0</td>
        <td>15.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#208135f9268dfd1af0b59d06891ddbf351a93f59" class="src_link" title="lib/bridge_watchbot.rb">lib/bridge_watchbot.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>32</td>
        <td>21</td>
        <td>21</td>
        <td>0</td>
        <td>18.4</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         11.4
       </span>
    </span> hits/line)
  </h2>
  <a name="Controllers"></a>
  <div>
    <b>2</b> files in total.
    <b>84</b> relevant lines. 
    <span class="green"><b>84</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#35abb7809ebeab7c0388667115bbe464c4b25d60" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>22</td>
        <td>8</td>
        <td>8</td>
        <td>0</td>
        <td>2.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6a39daa1be193c23afc6d0591edd8e8114a8c118" class="src_link" title="app/controllers/medias_controller.rb">app/controllers/medias_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>124</td>
        <td>76</td>
        <td>76</td>
        <td>0</td>
        <td>12.3</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Models"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Mailers"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         71.8
       </span>
    </span> hits/line)
  </h2>
  <a name="Helpers"></a>
  <div>
    <b>1</b> files in total.
    <b>47</b> relevant lines. 
    <span class="green"><b>47</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#255d8734f1b7ebd54e643d07715d4e7a73386401" class="src_link" title="app/helpers/medias_helper.rb">app/helpers/medias_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>77</td>
        <td>47</td>
        <td>47</td>
        <td>0</td>
        <td>71.8</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         31.92
       </span>
    </span> hits/line)
  </h2>
  <a name="Libraries"></a>
  <div>
    <b>6</b> files in total.
    <b>242</b> relevant lines. 
    <span class="green"><b>242</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#edb00029fef603b122b883fe21c263cfafb2888c" class="src_link" title="lib/bridge_cache.rb">lib/bridge_cache.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>155</td>
        <td>97</td>
        <td>97</td>
        <td>0</td>
        <td>33.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#609981825ce762ec9d5ac35293e1bda21bcdf1ad" class="src_link" title="lib/bridge_cc_deville.rb">lib/bridge_cc_deville.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>35</td>
        <td>21</td>
        <td>21</td>
        <td>0</td>
        <td>44.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8e3e4bf48032d2f0357011e60b97e48eb680fe26" class="src_link" title="lib/bridge_embedly.rb">lib/bridge_embedly.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>114</td>
        <td>72</td>
        <td>72</td>
        <td>0</td>
        <td>38.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#355c824cd93e6e09a323c34f340a7ece563928ae" class="src_link" title="lib/bridge_error_codes.rb">lib/bridge_error_codes.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#68f4895821170a6fa9875b5ab313e46f4662bb99" class="src_link" title="lib/bridge_google_authentication.rb">lib/bridge_google_authentication.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>43</td>
        <td>24</td>
        <td>24</td>
        <td>0</td>
        <td>15.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#208135f9268dfd1af0b59d06891ddbf351a93f59" class="src_link" title="lib/bridge_watchbot.rb">lib/bridge_watchbot.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>32</td>
        <td>21</td>
        <td>21</td>
        <td>0</td>
        <td>18.4</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         22.04
       </span>
    </span> hits/line)
  </h2>
  <a name="Ungrouped"></a>
  <div>
    <b>3</b> files in total.
    <b>202</b> relevant lines. 
    <span class="green"><b>202</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#e5c28d29e9d76faaa90ea5ff4bf9a47c7022d926" class="src_link" title="app/sources/base.rb">app/sources/base.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>77</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>16.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f94fb6ca82c3cdeae4b84916101736582bdc4b0c" class="src_link" title="app/sources/bridge_api.rb">app/sources/bridge_api.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>141</td>
        <td>73</td>
        <td>73</td>
        <td>0</td>
        <td>6.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#74a23a080a359d28269564b7aab69cb5aa3da9bd" class="src_link" title="app/sources/google_spreadsheet.rb">app/sources/google_spreadsheet.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>209</td>
        <td>110</td>
        <td>110</td>
        <td>0</td>
        <td>33.2</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.10.0 
        and simplecov-html v0.10.0<br/>
        using Unit Tests
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="35abb7809ebeab7c0388667115bbe464c4b25d60">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # Prevent CSRF attacks by raising an exception.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # For APIs, you may want to use :null_session instead.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  protect_from_forgery with: :null_session</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_success</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    json = { type: &#39;success&#39; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    render json: json, status: 200</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_error(message, code, status = 400)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="14">
          <span class="hits">15</span>
          
          <code class="ruby">    render json: { type: &#39;error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        message: message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        code: Bridge::ErrorCodes::const_get(code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    status: status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6a39daa1be193c23afc6d0591edd8e8114a8c118">
  <div class="header">
    <h3>app/controllers/medias_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>76</b> relevant lines. 
      <span class="green"><b>76</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bridge_cache&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bridge_error_codes&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">class MediasController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include Bridge::Cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  after_action :allow_iframe, only: :embed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :get_params, only: [:embed, :notify]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :get_host</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :set_headers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def embed</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="13">
          <span class="hits">26</span>
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="14">
          <span class="hits">42</span>
          
          <code class="ruby">      format.html { render_embed_as_html           }</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="15">
          <span class="hits">28</span>
          
          <code class="ruby">      format.js   { render_embed_as_js             }</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="16">
          <span class="hits">34</span>
          
          <code class="ruby">      format.png  { render_embed_as_png and return }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def notify</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="21">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="22">
          <span class="hits">3</span>
          
          <code class="ruby">      payload = request.raw_post</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">      if verify_signature(payload)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">        get_object and return</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">        @object.parse_notification(@collection, @item, JSON.parse(payload))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">        render_success</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">        render_error &#39;Signature could not be verified&#39;, &#39;INVALID_SIGNATURE&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      render_error e.message, &#39;EXCEPTION&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_embed_as_png</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="38">
          <span class="hits">8</span>
          
          <code class="ruby">    html = cache_path(@project, @collection, @item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="40">
          <span class="hits">8</span>
          
          <code class="ruby">    unless File.exists?(html)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="41">
          <span class="hits">8</span>
          
          <code class="ruby">      get_object and return</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="42">
          <span class="hits">8</span>
          
          <code class="ruby">      generate_cache(@object, @project, @collection, @item, @site)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="45">
          <span class="hits">8</span>
          
          <code class="ruby">    if File.exists?(html)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="46">
          <span class="hits">7</span>
          
          <code class="ruby">      css = URI.parse(params[:css].to_s).to_s</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="47">
          <span class="hits">7</span>
          
          <code class="ruby">      @image = generate_screenshot(@project, @collection, @item, css)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="48">
          <span class="hits">7</span>
          
          <code class="ruby">      send_data File.read(@image), type: &#39;image/png&#39;, disposition: &#39;inline&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      render_error(&#39;Item not found (deleted, maybe?)&#39;, &#39;NOT_FOUND&#39;, 404)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_embed_as_js</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">    @caller = request.original_url.gsub(/\?.*$/, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">    @caller_path = request.fullpath.gsub(/\?.*$/, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">    @url = @caller.gsub(/\.js.*$/, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="58">
          <span class="hits">2</span>
          
          <code class="ruby">    @path = [@project, @collection, @item].reject(&amp;:blank?).join(&#39;-&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_embed_as_html</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="62">
          <span class="hits">16</span>
          
          <code class="ruby">    @cachepath = cache_path(@project, @collection, @item)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="63">
          <span class="hits">16</span>
          
          <code class="ruby">    if BRIDGE_CONFIG[&#39;cache_embeds&#39;] &amp;&amp; File.exists?(@cachepath)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      @cache = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="66">
          <span class="hits">15</span>
          
          <code class="ruby">      get_object and return</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="67">
          <span class="hits">14</span>
          
          <code class="ruby">      generate_cache(@object, @project, @collection, @item, @site)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="68">
          <span class="hits">14</span>
          
          <code class="ruby">      @cache = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="71">
          <span class="hits">15</span>
          
          <code class="ruby">    logger.info &quot;Rendering cache file #{@cachepath}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="73">
          <span class="hits">15</span>
          
          <code class="ruby">    if File.exists?(@cachepath)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="74">
          <span class="hits">12</span>
          
          <code class="ruby">      render text: File.read(@cachepath)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="76">
          <span class="hits">3</span>
          
          <code class="ruby">      render_error(&#39;Item not found (deleted, maybe?)&#39;, &#39;NOT_FOUND&#39;, 404)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def allow_iframe</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="81">
          <span class="hits">26</span>
          
          <code class="ruby">    response.headers.except! &#39;X-Frame-Options&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def verify_signature(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">    signature = &#39;sha1=&#39; + OpenSSL::HMAC.hexdigest(OpenSSL::Digest.new(&#39;sha1&#39;), BRIDGE_CONFIG[&#39;secret_token&#39;].to_s, payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="86">
          <span class="hits">3</span>
          
          <code class="ruby">    Rack::Utils.secure_compare(signature, request.headers[&#39;X-Signature&#39;].to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_params</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="90">
          <span class="hits">37</span>
          
          <code class="ruby">    BRIDGE_PROJECTS.keys.each do |project|</code>
        </li>
      
        <li class="covered" data-hits="111" data-linenumber="91">
          <span class="hits">111</span>
          
          <code class="ruby">      @project = project if params[:project].to_s === project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="94">
          <span class="hits">37</span>
          
          <code class="ruby">    sanitize_parameters(params[:collection], params[:item])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="96">
          <span class="hits">37</span>
          
          <code class="ruby">    (render_error(&#39;Project not found&#39;, &#39;NOT_FOUND&#39;, 404) and return) if @project.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_object</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="100">
          <span class="hits">25</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="101">
          <span class="hits">25</span>
          
          <code class="ruby">      klass = &#39;Sources::&#39; + BRIDGE_PROJECTS[@project][&#39;type&#39;].camelize</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="102">
          <span class="hits">24</span>
          
          <code class="ruby">      @object = klass.constantize.new(@project, BRIDGE_PROJECTS[@project].except(&#39;type&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    rescue NameError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      render_error(&#39;Type not found&#39;, &#39;NOT_FOUND&#39;, 404) and return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="106">
          <span class="hits">24</span>
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_host</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="110">
          <span class="hits">29</span>
          
          <code class="ruby">    @host = request.host</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="111">
          <span class="hits">29</span>
          
          <code class="ruby">    @host_with_port = request.host_with_port</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="112">
          <span class="hits">29</span>
          
          <code class="ruby">    @protocol = request.protocol</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="113">
          <span class="hits">29</span>
          
          <code class="ruby">    @site = @protocol + @host_with_port</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_headers</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="117">
          <span class="hits">29</span>
          
          <code class="ruby">    response.headers[&#39;Cache-Control&#39;] = &#39;no-transform,public,max-age=600,s-maxage=300&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  def sanitize_parameters(collection, item)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="121">
          <span class="hits">37</span>
          
          <code class="ruby">    @collection = params[:collection].to_s.gsub(/[^0-9A-Za-z_\-\u0600-\u06ff\u0750-\u077f\ufb50-\ufc3f\ufe70-\ufefc]/, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="122">
          <span class="hits">37</span>
          
          <code class="ruby">    @item = params[:item].to_s.gsub(/[^0-9A-Za-z_-]/, &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="255d8734f1b7ebd54e643d07715d4e7a73386401">
  <div class="header">
    <h3>app/helpers/medias_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>47</b> relevant lines. 
      <span class="green"><b>47</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module MediasHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # From: https://github.com/twitter/twitter-text/blob/master/rb/lib/twitter-text/regex.rb</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  TWITTER_HASHTAG_ALPHA = /[\p{L}\p{M}]/</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  TWITTER_HASHTAG_ALPHANUMERIC = /[\p{L}\p{M}\p{Nd}_\u200c\u0482\ua673\ua67e\u05be\u05f3\u05f4\u309b\u309c\u30a0\u30fb\u3003\u0f0b\u0f0c\u0f0d]/</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  TWITTER_HASHTAG_BOUNDARY = /\A|\z|[^&amp;\p{L}\p{M}\p{Nd}_\u200c\u0482\ua673\ua67e\u05be\u05f3\u05f4\u309b\u309c\u30a0\u30fb\u3003\u0f0b\u0f0c\u0f0d]/</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  TWITTER_HASHTAG_REGEXP = /(#{TWITTER_HASHTAG_BOUNDARY})(#|＃)(#{TWITTER_HASHTAG_ALPHANUMERIC}*#{TWITTER_HASHTAG_ALPHA}#{TWITTER_HASHTAG_ALPHANUMERIC}*)/io</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_text(text)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="9">
          <span class="hits">282</span>
          
          <code class="ruby">    renderer = Redcarpet::Render::HTML.new(link_attributes: { target: &#39;_blank&#39; })</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="10">
          <span class="hits">282</span>
          
          <code class="ruby">    markdown = Redcarpet::Markdown.new(renderer, autolink: true, no_intra_emphasis: true)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="11">
          <span class="hits">282</span>
          
          <code class="ruby">    text = markdown.render(text)</code>
        </li>
      
        <li class="covered" data-hits="282" data-linenumber="12">
          <span class="hits">282</span>
          
          <code class="ruby">    text.html_safe.chomp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_translation(translation, provider)</code>
        </li>
      
        <li class="covered" data-hits="176" data-linenumber="16">
          <span class="hits">176</span>
          
          <code class="ruby">    text = translation[:text]</code>
        </li>
      
        <li class="covered" data-hits="176" data-linenumber="17">
          <span class="hits">176</span>
          
          <code class="ruby">    text = self.send(&quot;#{provider}_parse_translation&quot;, text) if !provider.blank? &amp;&amp; self.respond_to?(&quot;#{provider}_parse_translation&quot;)</code>
        </li>
      
        <li class="covered" data-hits="176" data-linenumber="18">
          <span class="hits">176</span>
          
          <code class="ruby">    text = parse_text(text).encode(&#39;UTF-8&#39;, invalid: :replace)</code>
        </li>
      
        <li class="covered" data-hits="176" data-linenumber="19">
          <span class="hits">176</span>
          
          <code class="ruby">    text.html_safe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def twitter_parse_translation(text)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="23">
          <span class="hits">94</span>
          
          <code class="ruby">    text = text.gsub(TWITTER_HASHTAG_REGEXP, &#39;\1&lt;a href=&quot;https://twitter.com/hashtag/\3&quot; target=&quot;_blank&quot;&gt;\2\3&lt;/a&gt;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="24">
          <span class="hits">94</span>
          
          <code class="ruby">    text.gsub(/([@＠])([a-zA-Z0-9_]{1,20})/, &#39;&lt;a href=&quot;https://twitter.com/\2&quot; target=&quot;_blank&quot;&gt;\1\2&lt;/a&gt;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def instagram_parse_translation(text)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="28">
          <span class="hits">71</span>
          
          <code class="ruby">    text = text.gsub(TWITTER_HASHTAG_REGEXP, &#39;\1&lt;a href=&quot;https://instagram.com/explore/tags/\3&quot; target=&quot;_blank&quot;&gt;\2\3&lt;/a&gt;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="29">
          <span class="hits">71</span>
          
          <code class="ruby">    text = text.gsub(/@([a-zA-Z0-9_]+)/, &#39;&lt;a href=&quot;http://instagram.com/\1&quot; target=&quot;_blank&quot;&gt;@\1&lt;/a&gt;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_twitter_tags(project, collection, item, level, site)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="33">
          <span class="hits">48</span>
          
          <code class="ruby">    if level === &#39;item&#39;</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="34">
          <span class="hits">22</span>
          
          <code class="ruby">      image = URI.join(site, &#39;medias/&#39;, &#39;embed/&#39;, project + &#39;/&#39;, URI.encode(collection) + &#39;/&#39;, &quot;#{item}.png&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      tag(:meta, name: &#39;twitter:card&#39;, content: &#39;photo&#39;) + &quot;\n&quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      tag(:meta, name: &#39;twitter:site&#39;, content: BRIDGE_CONFIG[&#39;twitter_handle&#39;]) + &quot;\n&quot; +</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="38">
          <span class="hits">22</span>
          
          <code class="ruby">      tag(:meta, name: &#39;twitter:image&#39;, content: image.to_s) + &quot;\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def short_url_for(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="43">
          <span class="hits">57</span>
          
          <code class="ruby">    require &#39;bitly&#39;</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="44">
          <span class="hits">57</span>
          
          <code class="ruby">    url = [BRIDGE_CONFIG[&#39;bridgembed_host&#39;], &#39;medias&#39;, &#39;embed&#39;, project, collection, item].join(&#39;/&#39;)</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="45">
          <span class="hits">57</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="46">
          <span class="hits">57</span>
          
          <code class="ruby">      bitly = Bitly.client.shorten(url)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      bitly.short_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="covered" data-hits="56" data-linenumber="49">
          <span class="hits">56</span>
          
          <code class="ruby">      url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_translation_direction(translation, provider)</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="54">
          <span class="hits">113</span>
          
          <code class="ruby">    text = parse_translation(translation, provider)</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="55">
          <span class="hits">113</span>
          
          <code class="ruby">    get_text_direction(text)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_comment_direction(comment)</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="59">
          <span class="hits">54</span>
          
          <code class="ruby">    text = parse_text(comment[:comment])</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="60">
          <span class="hits">54</span>
          
          <code class="ruby">    get_text_direction(text)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_text_direction(text)</code>
        </li>
      
        <li class="covered" data-hits="167" data-linenumber="64">
          <span class="hits">167</span>
          
          <code class="ruby">    direction = text.direction</code>
        </li>
      
        <li class="covered" data-hits="167" data-linenumber="65">
          <span class="hits">167</span>
          
          <code class="ruby">    direction == &#39;bidi&#39; ? &#39;rtl&#39; : direction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_google_analytics_tag</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="69">
          <span class="hits">50</span>
          
          <code class="ruby">    code = BRIDGE_CONFIG[&#39;google_analytics_code&#39;]</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="70">
          <span class="hits">50</span>
          
          <code class="ruby">    if code.blank?</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="71">
          <span class="hits">49</span>
          
          <code class="ruby">      &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">      content = &quot;(function(i,s,o,g,r,a,m){i[&#39;GoogleAnalyticsObject&#39;]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,&#39;script&#39;,&#39;//www.google-analytics.com/analytics.js&#39;,&#39;ga&#39;);ga(&#39;create&#39;, &#39;%s&#39;, &#39;auto&#39;);ga(&#39;send&#39;, &#39;pageview&#39;);&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      javascript_tag(content % code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e5c28d29e9d76faaa90ea5ff4bf9a47c7022d926">
  <div class="header">
    <h3>app/sources/base.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Sources</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(project, config = {})</code>
        </li>
      
        <li class="covered" data-hits="89" data-linenumber="4">
          <span class="hits">89</span>
          
          <code class="ruby">      @project = project</code>
        </li>
      
        <li class="covered" data-hits="89" data-linenumber="5">
          <span class="hits">89</span>
          
          <code class="ruby">      @config = config</code>
        </li>
      
        <li class="covered" data-hits="89" data-linenumber="6">
          <span class="hits">89</span>
          
          <code class="ruby">      raise &quot;Cannot directly instantiate this class&quot; if self.class == Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def project</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="10">
          <span class="hits">35</span>
          
          <code class="ruby">      @project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      # Generate a string representation of this instance</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_item(collection, item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # Return a single item from a collection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # Please return something like the structure below.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      # It&#39;s advisable to cache this structure.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      # {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      #   id: item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      #   source_text: source text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      #   source_lang: source lang</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      #   link: source link</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      #   timestamp:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      #   translations: [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      #     {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      #       translator_name:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      #       translator_url:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      #       timestamp:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      #       text:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      #       lang:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      #       comments: [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      #         {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      #           commenter_name:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      #           commenter_url:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      #           timestamp:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      #           comment:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      #         },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      #         (...)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      #       ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      #     },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      #     (...)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      #   ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      #   source: used internally (links to the source class instance that generated this)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      #   index: where does this translation is located in the respective collection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      # }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_collection(collection, item = nil, force = false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      # Return a list of &lt;entries&gt; as [&lt;entry-1&gt;, &lt;entry-2&gt;, ..., &lt;entry-n&gt;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      # Each &lt;entry-i&gt; is defined as in `get_entry` method above</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_project(collection = nil, item = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # Return a list of collection ids, like: [ &lt;collection-id-1&gt;, &lt;collection-id-2&gt;, ..., &lt;collection-n&gt; ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_availability(item, available = false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      # Bridge::Embedly calls this method when some item is not available</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_new_item(collection, item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      # Bridge::Cache calls this method when caching this item for the first time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_notification(collection, item, payload = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      # MediasController#notify calls this method when notified to alter some embed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f94fb6ca82c3cdeae4b84916101736582bdc4b0c">
  <div class="header">
    <h3>app/sources/bridge_api.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>73</b> relevant lines. 
      <span class="green"><b>73</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bridge_cache&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Sources</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class BridgeApi &lt; Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bridge::Cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # First, the methods overwritten from Source::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(project, config = {})</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="10">
          <span class="hits">13</span>
          
          <code class="ruby">      @project = project</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="11">
          <span class="hits">13</span>
          
          <code class="ruby">      @config = config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # authenticate</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="13">
          <span class="hits">13</span>
          
          <code class="ruby">      super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      @project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_item(channel, translation_id)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="21">
          <span class="hits">6</span>
          
          <code class="ruby">      translation = self.make_request(&quot;translations/#{translation_id.to_i}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="22">
          <span class="hits">6</span>
          
          <code class="ruby">      translation_to_hash(translation) unless translation.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_collection(channel, translation_id = nil, force = false)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="26">
          <span class="hits">10</span>
          
          <code class="ruby">      if @translations.nil? || force</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="27">
          <span class="hits">7</span>
          
          <code class="ruby">        @translations = self.make_request(&#39;translations&#39;, { channel_uuid: URI.encode(channel) })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="29">
          <span class="hits">20</span>
          
          <code class="ruby">      @translations.to_a.collect{ |t| translation_to_hash(t) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_project(channel = nil, translation_id = nil)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="33">
          <span class="hits">24</span>
          
          <code class="ruby">      self.make_request(&quot;projects/#{@project}/channels&quot;).to_a.select{ |c| c[&#39;translations_count&#39;] &gt; 0 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_notification(channel, translation_id, payload = {})</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="37">
          <span class="hits">6</span>
          
          <code class="ruby">      if !payload[&#39;project&#39;].blank?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">        self.handle_project(payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      elsif payload[&#39;condition&#39;] == &#39;created&#39; || payload[&#39;condition&#39;] == &#39;updated&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">        self.update_cache_for_saved_translation(channel, payload[&#39;translation&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      elsif payload[&#39;condition&#39;] == &#39;destroyed&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">        self.update_cache_for_removed_translation(channel, translation_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="45">
          <span class="hits">6</span>
          
          <code class="ruby">      refresh_cache(channel) unless channel.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    def handle_project(payload)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="49">
          <span class="hits">3</span>
          
          <code class="ruby">      if payload[&#39;condition&#39;] == &#39;created&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">        slug = payload[&#39;project&#39;][&#39;slug&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">        dir = File.join(Rails.root, &#39;config&#39;, &#39;projects&#39;, Rails.env)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">        from = File.join(dir, &#39;bridge-api.yml&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">        to = File.join(dir, slug + &#39;.yml&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">        FileUtils.ln_s(from, to)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">        BRIDGE_PROJECTS[slug] = BRIDGE_PROJECTS[&#39;bridge-api&#39;]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">      elsif payload[&#39;condition&#39;] == &#39;updated&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">        generate_cache(self, self.project, &#39;&#39;, &#39;&#39;, BRIDGE_CONFIG[&#39;bridgembed_host&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def refresh_cache(channel)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="62">
          <span class="hits">3</span>
          
          <code class="ruby">      generate_cache(self, self.project, channel, &#39;&#39;, BRIDGE_CONFIG[&#39;bridgembed_host&#39;])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="63">
          <span class="hits">3</span>
          
          <code class="ruby">      remove_screenshot(self.project, channel, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="64">
          <span class="hits">3</span>
          
          <code class="ruby">      generate_cache(self, self.project, &#39;&#39;, &#39;&#39;, BRIDGE_CONFIG[&#39;bridgembed_host&#39;])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="65">
          <span class="hits">3</span>
          
          <code class="ruby">      remove_screenshot(self.project, &#39;&#39;, &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    def update_cache_for_saved_translation(channel, translation)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="69">
          <span class="hits">2</span>
          
          <code class="ruby">      Rails.cache.delete(&#39;embedly:&#39; + translation[&#39;id&#39;].to_s)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="70">
          <span class="hits">2</span>
          
          <code class="ruby">      @entries = [translation]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="71">
          <span class="hits">2</span>
          
          <code class="ruby">      generate_cache(self, self.project, channel, translation[&#39;id&#39;].to_s, BRIDGE_CONFIG[&#39;bridgembed_host&#39;])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="72">
          <span class="hits">2</span>
          
          <code class="ruby">      remove_screenshot(self.project, channel, translation[&#39;id&#39;].to_s)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="73">
          <span class="hits">2</span>
          
          <code class="ruby">      @entries = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    def update_cache_for_removed_translation(channel, translation_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      clear_cache(self.project, channel, translation_id.to_s) </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">      remove_screenshot(self.project, channel, translation_id.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def translation_to_hash(translation)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="82">
          <span class="hits">15</span>
          
          <code class="ruby">      hash = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        id: translation[&#39;id&#39;].to_s,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        source_text: translation[&#39;source&#39;][&#39;text&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        source_lang: translation[&#39;source&#39;][&#39;lang&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        link: translation[&#39;source&#39;][&#39;link&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        timestamp: translation[&#39;source&#39;][&#39;published&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        translations: [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">            translator_name: translation[&#39;author&#39;][&#39;name&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">            translator_url: translation[&#39;author&#39;][&#39;link&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">            text: translation[&#39;text&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">            lang: translation[&#39;lang&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">            timestamp: translation[&#39;published&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">            comments: self.comments_from_translation(translation)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        source: self,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        index: translation[&#39;id&#39;].to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="101">
          <span class="hits">15</span>
          
          <code class="ruby">      hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    def comments_from_translation(translation)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="105">
          <span class="hits">15</span>
          
          <code class="ruby">      comments = []</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="106">
          <span class="hits">15</span>
          
          <code class="ruby">      translation[&#39;comments&#39;].each do |comment|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        comments &lt;&lt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">          commenter_name: comment[&#39;author&#39;][&#39;name&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          commenter_url: comment[&#39;author&#39;][&#39;link&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">          comment: comment[&#39;text&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">          timestamp: comment[&#39;published&#39;]</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="112">
          <span class="hits">15</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="114">
          <span class="hits">15</span>
          
          <code class="ruby">      comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    def format_params(params = {})</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="120">
          <span class="hits">16</span>
          
          <code class="ruby">      query = []</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="121">
          <span class="hits">16</span>
          
          <code class="ruby">      params.each do |key, value|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="122">
          <span class="hits">4</span>
          
          <code class="ruby">        query &lt;&lt; &quot;#{key}=#{value}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="124">
          <span class="hits">16</span>
          
          <code class="ruby">      query.join(&#39;&amp;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    def make_request(endpoint, params = {})</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="128">
          <span class="hits">19</span>
          
          <code class="ruby">      uri = URI.join(@config[&#39;bridge_api_host&#39;], &#39;api/&#39;, endpoint)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="129">
          <span class="hits">19</span>
          
          <code class="ruby">      request = Net::HTTP::Get.new(uri.path + &#39;?&#39; + format_params(params))</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="130">
          <span class="hits">19</span>
          
          <code class="ruby">      request[&#39;Authorization&#39;] = &#39;Token token=&#39; + @config[&#39;bridge_api_token&#39;].to_s</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="131">
          <span class="hits">19</span>
          
          <code class="ruby">      http = Net::HTTP.new(uri.hostname, uri.port)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="132">
          <span class="hits">19</span>
          
          <code class="ruby">      http.use_ssl = uri.scheme == &#39;https&#39;</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="133">
          <span class="hits">19</span>
          
          <code class="ruby">      response = http.request(request)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="134">
          <span class="hits">19</span>
          
          <code class="ruby">      parse_response(response)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_response(response)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="138">
          <span class="hits">19</span>
          
          <code class="ruby">      response.code.to_i === 200 ? JSON.parse(response.body)[&#39;data&#39;] : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="74a23a080a359d28269564b7aab69cb5aa3da9bd">
  <div class="header">
    <h3>app/sources/google_spreadsheet.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>110</b> relevant lines. 
      <span class="green"><b>110</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;google_drive&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bridge_cache&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bridge_watchbot&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bridge_google_authentication&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">module Sources</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  class GoogleSpreadsheet &lt; Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bridge::Cache</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    include Bridge::GoogleAuthentication</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # First, the methods overwritten from Source::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(project, config = {})</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="14">
          <span class="hits">68</span>
          
          <code class="ruby">      @project = project</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="15">
          <span class="hits">68</span>
          
          <code class="ruby">      @config = config</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="16">
          <span class="hits">68</span>
          
          <code class="ruby">      authenticate do</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="17">
          <span class="hits">69</span>
          
          <code class="ruby">        get_spreadsheet(@config[&#39;google_spreadsheet_id&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="19">
          <span class="hits">68</span>
          
          <code class="ruby">      super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    def to_s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      get_title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_item(worksheet, hash)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="27">
          <span class="hits">19</span>
          
          <code class="ruby">      return if get_worksheet(worksheet).blank?</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="28">
          <span class="hits">19</span>
          
          <code class="ruby">      link = get_entries(hash)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="29">
          <span class="hits">19</span>
          
          <code class="ruby">      link.blank? ? nil : link.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_collection(worksheet, hash = nil, force = false)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="33">
          <span class="hits">17</span>
          
          <code class="ruby">      return if get_worksheet(worksheet, force).blank?</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="34">
          <span class="hits">14</span>
          
          <code class="ruby">      get_entries(nil, force)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_project(worksheet = nil, hash = nil)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="38">
          <span class="hits">12</span>
          
          <code class="ruby">      @collections ||= get_worksheets.map(&amp;:title).collect{ |title| { &#39;name&#39; =&gt; title, &#39;id&#39; =&gt; title, &#39;project&#39; =&gt; @project } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_availability(entry, available)</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="42">
          <span class="hits">70</span>
          
          <code class="ruby">      if available</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="43">
          <span class="hits">41</span>
          
          <code class="ruby">        url = entry[:link] + &#39;#&#39; + entry[:source].get_title</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="44">
          <span class="hits">41</span>
          
          <code class="ruby">        self.notify_watchbot(url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="47">
          <span class="hits">70</span>
          
          <code class="ruby">      index = entry[:index]</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="48">
          <span class="hits">70</span>
          
          <code class="ruby">      worksheet = get_worksheet</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="49">
          <span class="hits">70</span>
          
          <code class="ruby">      value = available ? &#39;No&#39; : &#39;Yes&#39;</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="50">
          <span class="hits">70</span>
          
          <code class="ruby">      unless worksheet[index, 9].to_s == value.to_s</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="51">
          <span class="hits">4</span>
          
          <code class="ruby">        worksheet[1, 9] = &#39;Unavailable?&#39;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="52">
          <span class="hits">4</span>
          
          <code class="ruby">        worksheet[index, 9] = value</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="53">
          <span class="hits">4</span>
          
          <code class="ruby">        Retryable.retryable tries: 5 do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="54">
          <span class="hits">4</span>
          
          <code class="ruby">          worksheet.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_new_item(worksheet, entry)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="60">
          <span class="hits">30</span>
          
          <code class="ruby">      if entry.blank? &amp;&amp; worksheet.present?</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="61">
          <span class="hits">10</span>
          
          <code class="ruby">        url = get_worksheet.spreadsheet.human_url + &#39;#&#39; + worksheet</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="62">
          <span class="hits">10</span>
          
          <code class="ruby">        self.notify_watchbot(url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_watchbot(url)</code>
        </li>
      
        <li class="covered" data-hits="51" data-linenumber="67">
          <span class="hits">51</span>
          
          <code class="ruby">      Bridge::Watchbot.new(@config[&#39;watchbot&#39;]).send(url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_notification(collection, item, payload = {})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      uri = URI.parse(Rack::Utils.unescape(payload[&#39;link&#39;]))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">      link = uri.to_s.gsub(&#39;#&#39; + uri.fragment, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">      get_worksheet(uri.fragment)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      notify_link_condition(link, payload[&#39;condition&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_spreadsheet(id = &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="78">
          <span class="hits">123</span>
          
          <code class="ruby">      @spreadsheet ||= @session.spreadsheet_by_key(id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_title(title = &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="92" data-linenumber="82">
          <span class="hits">92</span>
          
          <code class="ruby">      @title = title unless title.blank?</code>
        </li>
      
        <li class="covered" data-hits="92" data-linenumber="83">
          <span class="hits">92</span>
          
          <code class="ruby">      @title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_url(row)</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="87">
          <span class="hits">150</span>
          
          <code class="ruby">      get_worksheet[row, 2].gsub(&#39; &#39;, &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_worksheet(title = &#39;&#39;, force = false)</code>
        </li>
      
        <li class="covered" data-hits="483" data-linenumber="91">
          <span class="hits">483</span>
          
          <code class="ruby">      if @worksheet.blank? || force</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="92">
          <span class="hits">49</span>
          
          <code class="ruby">        @worksheet = get_spreadsheet.worksheet_by_title(get_title(title))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="483" data-linenumber="94">
          <span class="hits">483</span>
          
          <code class="ruby">      @worksheet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    def reset_entries</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">      @entries = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_entries(link = nil, force = false)</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="102">
          <span class="hits">44</span>
          
          <code class="ruby">      if @entries.blank? || force</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="103">
          <span class="hits">36</span>
          
          <code class="ruby">        worksheet = self.get_worksheet</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="104">
          <span class="hits">36</span>
          
          <code class="ruby">        @entries = []</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="105">
          <span class="hits">36</span>
          
          <code class="ruby">        for row in 2..worksheet.num_rows</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="106">
          <span class="hits">150</span>
          
          <code class="ruby">          Retryable.retryable tries: 5 do</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="107">
          <span class="hits">150</span>
          
          <code class="ruby">            hash = row_to_hash(row)</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="108">
          <span class="hits">150</span>
          
          <code class="ruby">            @entries &lt;&lt; hash if link.nil? || link == hash[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="112">
          <span class="hits">44</span>
          
          <code class="ruby">      @entries</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_worksheets</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="116">
          <span class="hits">4</span>
          
          <code class="ruby">      @worksheets ||= get_spreadsheet.worksheets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">    def row_to_hash(row)</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="122">
          <span class="hits">150</span>
          
          <code class="ruby">      worksheet = get_worksheet</code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="123">
          <span class="hits">150</span>
          
          <code class="ruby">      link = self.get_url(row)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        id: Digest::SHA1.hexdigest(link),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        source_text: worksheet[row, 1],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        source_lang: &#39;unk&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        link: link,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        timestamp: &#39;&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        translations: [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">            translator_name: worksheet[row, 5],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">            translator_url: worksheet[row, 6],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">            text: worksheet[row, 3],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">            lang: &#39;en&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">            timestamp: &#39;&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">            comments:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">              worksheet[row, 4].blank? ?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">                [] :</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">                [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">                  {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">                    commenter_name: worksheet[row, 7],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">                    commenter_url: worksheet[row, 8],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">                    comment: worksheet[row, 4],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">                    timestamp: &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">                  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">                ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">        ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">        source: self, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        index: row </code>
        </li>
      
        <li class="covered" data-hits="150" data-linenumber="152">
          <span class="hits">150</span>
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_link_condition(link, condition)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="156">
          <span class="hits">3</span>
          
          <code class="ruby">      case condition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      when &#39;check404&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="158">
          <span class="hits">2</span>
          
          <code class="ruby">        notify_entry_offline(link)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      when &#39;check_google_spreadsheet_updated&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">        notify_google_spreadsheet_updated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_entry_offline(link)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="165">
          <span class="hits">2</span>
          
          <code class="ruby">      hash = Digest::SHA1.hexdigest(link)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="166">
          <span class="hits">2</span>
          
          <code class="ruby">      cache_key = &#39;embedly:&#39; + hash</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="167">
          <span class="hits">2</span>
          
          <code class="ruby">      entry = Rails.cache.fetch(cache_key)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="168">
          <span class="hits">2</span>
          
          <code class="ruby">      worksheet = self.get_worksheet.title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="170">
          <span class="hits">2</span>
          
          <code class="ruby">      unless entry.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">        entry[:oembed][&#39;unavailable&#39;] = true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">        Rails.cache.write(cache_key, entry)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">        entry[:source] = self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">        notify_availability(entry, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">        self.refresh_cache_milestone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">        clear_cache(self.project, worksheet, hash)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">        remove_screenshot(self.project, worksheet, hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    # FIXME: We can improve the performance here</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_google_spreadsheet_updated</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">      worksheet = self.get_worksheet.title</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      entries = self.get_entries</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">      entries.each do |entry|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="190">
          <span class="hits">4</span>
          
          <code class="ruby">        hash = entry[:id]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="191">
          <span class="hits">4</span>
          
          <code class="ruby">        Rails.cache.delete(&#39;embedly:&#39; + hash)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="192">
          <span class="hits">4</span>
          
          <code class="ruby">        @entries = [entry]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="193">
          <span class="hits">4</span>
          
          <code class="ruby">        generate_cache(self, self.project, worksheet, hash, BRIDGE_CONFIG[&#39;bridgembed_host&#39;])</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="194">
          <span class="hits">4</span>
          
          <code class="ruby">        remove_screenshot(self.project, worksheet, hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">        # generate_screenshot(self.project, worksheet, hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">      @entries = entries</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">      self.refresh_cache_milestone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">    def refresh_cache_milestone</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="203">
          <span class="hits">2</span>
          
          <code class="ruby">      worksheet = self.get_worksheet.title</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="204">
          <span class="hits">2</span>
          
          <code class="ruby">      generate_cache(self, self.project, worksheet, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="205">
          <span class="hits">2</span>
          
          <code class="ruby">      remove_screenshot(self.project, worksheet, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="206">
          <span class="hits">2</span>
          
          <code class="ruby">      generate_screenshot(self.project, worksheet, &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="edb00029fef603b122b883fe21c263cfafb2888c">
  <div class="header">
    <h3>lib/bridge_cache.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>97</b> relevant lines. 
      <span class="green"><b>97</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bridge_embedly&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bridge_cc_deville&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;smartshot&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Bridge</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  module Cache</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    def clear_cache(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="8">
          <span class="hits">12</span>
          
          <code class="ruby">      FileUtils.rm_rf(cache_path(project, collection, item))</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="9">
          <span class="hits">12</span>
          
          <code class="ruby">      notify_cc_service(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="10">
          <span class="hits">12</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def cache_path(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="157" data-linenumber="14">
          <span class="hits">157</span>
          
          <code class="ruby">      self.file_path(project, collection, item, &#39;cache&#39;, &#39;html&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def cache_exists?(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="18">
          <span class="hits">3</span>
          
          <code class="ruby">      File.exists?(cache_path(project, collection, item))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    def screenshot_exists?(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">      File.exists?(screenshot_path(project, collection, item))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_cache(object, project, collection, item, site = BRIDGE_CONFIG[&#39;bridgembed_host&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # Check first if item exists</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="27">
          <span class="hits">52</span>
          
          <code class="ruby">      level = get_level(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="28">
          <span class="hits">52</span>
          
          <code class="ruby">      entries = get_entries_from_source(object, collection, item, level)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="29">
          <span class="hits">52</span>
          
          <code class="ruby">      clear_cache(project, collection, item) and return if entries.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="31">
          <span class="hits">48</span>
          
          <code class="ruby">      path = cache_path(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="32">
          <span class="hits">48</span>
          
          <code class="ruby">      dir = File.dirname(path)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="33">
          <span class="hits">48</span>
          
          <code class="ruby">      FileUtils.mkdir_p(dir) unless File.exists?(dir)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="34">
          <span class="hits">48</span>
          
          <code class="ruby">      new_item = !File.exists?(path)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="35">
          <span class="hits">48</span>
          
          <code class="ruby">      save_cache_file(object, project, collection, item, level, entries, site)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="36">
          <span class="hits">48</span>
          
          <code class="ruby">      object.notify_new_item(collection, item) if new_item</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="37">
          <span class="hits">48</span>
          
          <code class="ruby">      notify_cc_service(project, collection, item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    def remove_screenshot(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="41">
          <span class="hits">19</span>
          
          <code class="ruby">      FileUtils.rm_rf(screenshot_path(project, collection, item))</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="42">
          <span class="hits">19</span>
          
          <code class="ruby">      notify_cc_service(project, collection, item, &#39;png&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    def screenshot_path(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="46">
          <span class="hits">35</span>
          
          <code class="ruby">      self.file_path(project, collection, item, &#39;screenshots&#39;, &#39;png&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    def screenshoter</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="50">
          <span class="hits">15</span>
          
          <code class="ruby">      path = File.join(Rails.root, &#39;bin&#39;, &#39;phantomjs-&#39; + (1.size * 8).to_s)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="51">
          <span class="hits">15</span>
          
          <code class="ruby">      version = `#{path} --version`</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="52">
          <span class="hits">15</span>
          
          <code class="ruby">      if (version.chomp =~ /^[0-9.]+$/).nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">        path = `which phantomjs`</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">        version = `#{path.chomp} --version`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="57">
          <span class="hits">15</span>
          
          <code class="ruby">      raise &#39;PhantomJS not found!&#39; if (version.chomp =~ /^[0-9.]+$/).nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="59">
          <span class="hits">14</span>
          
          <code class="ruby">      options = { phantomjs: path.chomp, timeout: 40 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="61">
          <span class="hits">14</span>
          
          <code class="ruby">      if Rails.env.test?</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="62">
          <span class="hits">14</span>
          
          <code class="ruby">        options.merge! run_server: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="65">
          <span class="hits">14</span>
          
          <code class="ruby">      Smartshot::Screenshot.new(options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_screenshot(project, collection, item, css = &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="69">
          <span class="hits">12</span>
          
          <code class="ruby">      output = screenshot_path(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="70">
          <span class="hits">12</span>
          
          <code class="ruby">      if BRIDGE_CONFIG[&#39;cache_embeds&#39;] &amp;&amp; File.exists?(output)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        # Cache file will be returned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="73">
          <span class="hits">11</span>
          
          <code class="ruby">        url = self.screenshot_url(project, collection, item, css)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="75">
          <span class="hits">11</span>
          
          <code class="ruby">        frames = []</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="76">
          <span class="hits">11</span>
          
          <code class="ruby">        element = [&#39;body&#39;]</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="77">
          <span class="hits">11</span>
          
          <code class="ruby">        link = Rails.cache.read(&#39;embedly:&#39; + item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="79">
          <span class="hits">11</span>
          
          <code class="ruby">        unless link.nil?</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="80">
          <span class="hits">7</span>
          
          <code class="ruby">          case link[:provider]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">          when &#39;twitter&#39;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="82">
          <span class="hits">4</span>
          
          <code class="ruby">            frames  = [0]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="83">
          <span class="hits">4</span>
          
          <code class="ruby">            element = [&#39;.twitter-tweet-rendered&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          when &#39;instagram&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">            frames  = [0]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="86">
          <span class="hits">3</span>
          
          <code class="ruby">            element = [&#39;img.art-bd-img&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="90">
          <span class="hits">11</span>
          
          <code class="ruby">        self.take_screenshot(url, element, frames, output)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="92">
          <span class="hits">12</span>
          
          <code class="ruby">      output</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    def take_screenshot(url, element, frames, output)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="96">
          <span class="hits">12</span>
          
          <code class="ruby">      FileUtils.mkdir_p(File.dirname(output))</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="97">
          <span class="hits">12</span>
          
          <code class="ruby">      tmp = Tempfile.new([&#39;screenshot&#39;, &#39;.png&#39;]).path</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="98">
          <span class="hits">12</span>
          
          <code class="ruby">      screenshoter.take_screenshot!(url: url, output: tmp, wait_for_element: element, frames_path: frames, sleep: 20)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="99">
          <span class="hits">12</span>
          
          <code class="ruby">      FileUtils.cp(tmp, output)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="100">
          <span class="hits">12</span>
          
          <code class="ruby">      FileUtils.rm(tmp)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_cc_service(project, collection, item, format = nil)</code>
        </li>
      
        <li class="covered" data-hits="79" data-linenumber="104">
          <span class="hits">79</span>
          
          <code class="ruby">      return if BRIDGE_CONFIG[&#39;cc_deville_host&#39;].blank?</code>
        </li>
      
        <li class="covered" data-hits="546" data-linenumber="105">
          <span class="hits">546</span>
          
          <code class="ruby">      url = [BRIDGE_CONFIG[&#39;bridgembed_host&#39;], &#39;medias&#39;, &#39;embed&#39;, project, URI.encode(collection), item].reject{ |part| part.blank? }.join(&#39;/&#39;)</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="106">
          <span class="hits">78</span>
          
          <code class="ruby">      url += &#39;.&#39; + format unless format.blank?</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="107">
          <span class="hits">78</span>
          
          <code class="ruby">      cc = Bridge::CcDeville.new(BRIDGE_CONFIG[&#39;cc_deville_host&#39;], BRIDGE_CONFIG[&#39;cc_deville_token&#39;], BRIDGE_CONFIG[&#39;cc_deville_httpauth&#39;])</code>
        </li>
      
        <li class="covered" data-hits="78" data-linenumber="108">
          <span class="hits">78</span>
          
          <code class="ruby">      cc.clear_cache(url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_level(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="114">
          <span class="hits">52</span>
          
          <code class="ruby">      if !item.blank?</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="115">
          <span class="hits">23</span>
          
          <code class="ruby">        &#39;item&#39;</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="116">
          <span class="hits">29</span>
          
          <code class="ruby">      elsif !collection.blank?</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="117">
          <span class="hits">22</span>
          
          <code class="ruby">        &#39;collection&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="119">
          <span class="hits">7</span>
          
          <code class="ruby">        &#39;project&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_entries_from_source(object, collection, item, level)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="124">
          <span class="hits">52</span>
          
          <code class="ruby">      embedly = Bridge::Embedly.new BRIDGE_CONFIG[&#39;embedly_key&#39;]</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="125">
          <span class="hits">52</span>
          
          <code class="ruby">      entries = object.send(&quot;get_#{level}&quot;, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="126">
          <span class="hits">52</span>
          
          <code class="ruby">      entries.blank? ? [] : embedly.send(&quot;parse_#{level}&quot;, entries)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    def save_cache_file(object, project, collection, item, level, entries, site = nil)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="130">
          <span class="hits">48</span>
          
          <code class="ruby">      path = self.get_components(project, collection, item).join(&#39;-&#39;)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="131">
          <span class="hits">48</span>
          
          <code class="ruby">      av = ActionView::Base.new(Rails.root.join(&#39;app&#39;, &#39;views&#39;))</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="132">
          <span class="hits">48</span>
          
          <code class="ruby">      av.assign(entries: entries, project: project, collection: collection,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">                item: item, site: site, level: level, path: path)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="134">
          <span class="hits">48</span>
          
          <code class="ruby">      ActionView::Base.send :include, MediasHelper</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="135">
          <span class="hits">48</span>
          
          <code class="ruby">      f = File.new(cache_path(project, collection, item), &#39;w+&#39;)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="136">
          <span class="hits">48</span>
          
          <code class="ruby">      f.puts(av.render(template: &quot;medias/embed-#{level}.html.erb&quot;, layout: &quot;layouts/application.html.erb&quot;))</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="137">
          <span class="hits">48</span>
          
          <code class="ruby">      f.close</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    def screenshot_url(project, collection, item, css = &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="141">
          <span class="hits">11</span>
          
          <code class="ruby">      url = [BRIDGE_CONFIG[&#39;bridgembed_host_private&#39;], &#39;medias&#39;, &#39;embed&#39;, project, URI.encode(collection), item].join(&#39;/&#39;) + &quot;?#{Time.now.to_i}&quot;</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="142">
          <span class="hits">11</span>
          
          <code class="ruby">      url += &quot;#css=#{css}&quot; unless css.blank?</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="143">
          <span class="hits">11</span>
          
          <code class="ruby">      url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_components(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="240" data-linenumber="147">
          <span class="hits">240</span>
          
          <code class="ruby">      [project, collection, item].reject(&amp;:empty?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">    def file_path(project, collection, item, basedir, extension)</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="151">
          <span class="hits">192</span>
          
          <code class="ruby">      path = self.get_components(project, collection, item)</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="152">
          <span class="hits">192</span>
          
          <code class="ruby">      File.join(Rails.root, &#39;public&#39;, basedir, path) + &#39;.&#39; + extension</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="609981825ce762ec9d5ac35293e1bda21bcdf1ad">
  <div class="header">
    <h3>lib/bridge_cc_deville.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bridge</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class CcDeville</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(host, token, httpauth = nil)</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="4">
          <span class="hits">81</span>
          
          <code class="ruby">      @host = host</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="5">
          <span class="hits">81</span>
          
          <code class="ruby">      @token = token</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="6">
          <span class="hits">81</span>
          
          <code class="ruby">      @httpauth = httpauth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def clear_cache(url)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="10">
          <span class="hits">71</span>
          
          <code class="ruby">      response = make_request(&#39;delete&#39;, &#39;purge&#39;, URI.encode(url))</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="11">
          <span class="hits">71</span>
          
          <code class="ruby">      response.code.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    def get_status(url)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="15">
          <span class="hits">4</span>
          
          <code class="ruby">      response = make_request(&#39;get&#39;, &#39;status&#39;, URI.encode(url))</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="16">
          <span class="hits">4</span>
          
          <code class="ruby">      JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    def make_request(verb, endpoint, url)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="22">
          <span class="hits">75</span>
          
          <code class="ruby">      uri = URI.join(@host, endpoint)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="23">
          <span class="hits">75</span>
          
          <code class="ruby">      klass = &quot;Net::HTTP::#{verb.camelize}&quot;.constantize</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="24">
          <span class="hits">75</span>
          
          <code class="ruby">      request = klass.new(uri.path + &#39;?url=&#39; + url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      # unless @httpauth.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      #   username, password = @httpauth.split(&#39;:&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      #   request.basic_auth username, password</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      # end</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="29">
          <span class="hits">75</span>
          
          <code class="ruby">      request.add_field(&#39;x-cc-deville-token&#39;, @token)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="30">
          <span class="hits">75</span>
          
          <code class="ruby">      http = Net::HTTP.new(uri.hostname, uri.port)</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="31">
          <span class="hits">75</span>
          
          <code class="ruby">      http.use_ssl = uri.scheme == &#39;https&#39;</code>
        </li>
      
        <li class="covered" data-hits="75" data-linenumber="32">
          <span class="hits">75</span>
          
          <code class="ruby">      http.request(request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8e3e4bf48032d2f0357011e60b97e48eb680fe26">
  <div class="header">
    <h3>lib/bridge_embedly.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>72</b> relevant lines. 
      <span class="green"><b>72</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;embedly&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;twitter&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Bridge</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  class Embedly</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(key)</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="9">
          <span class="hits">66</span>
          
          <code class="ruby">      connect_to_api(key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    def connect_to_api(key = &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="149" data-linenumber="13">
          <span class="hits">149</span>
          
          <code class="ruby">      @api ||= ::Embedly::API.new(key: key, user_agent: &#39;Mozilla/5.0 (compatible; Bridge/1.0; bridge@meedanlabs.com)&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    def call_oembed(link)</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="17">
          <span class="hits">82</span>
          
          <code class="ruby">      oembed = {}</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="18">
          <span class="hits">82</span>
          
          <code class="ruby">      Retryable.retryable tries: 5, sleep: 3 do</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="19">
          <span class="hits">82</span>
          
          <code class="ruby">        oembed = connect_to_api.oembed(url: link).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="21">
          <span class="hits">82</span>
          
          <code class="ruby">      raise oembed.error_message if oembed.type === &#39;error&#39;</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="22">
          <span class="hits">67</span>
          
          <code class="ruby">      oembed[:link] = link</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="23">
          <span class="hits">67</span>
          
          <code class="ruby">      oembed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_entry(entry)</code>
        </li>
      
        <li class="covered" data-hits="97" data-linenumber="27">
          <span class="hits">97</span>
          
          <code class="ruby">      Rails.cache.fetch(&#39;embedly:&#39; + entry[:id]) do</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="28">
          <span class="hits">82</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="29">
          <span class="hits">82</span>
          
          <code class="ruby">          oembed = call_oembed(entry[:link])</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="30">
          <span class="hits">67</span>
          
          <code class="ruby">          entry[:provider] = provider = oembed.provider_name.to_s.underscore</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="31">
          <span class="hits">67</span>
          
          <code class="ruby">          entry[:oembed] = self.alter_oembed(oembed, provider)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        rescue</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="33">
          <span class="hits">15</span>
          
          <code class="ruby">          entry[:oembed] = { &#39;unavailable&#39; =&gt; true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="35">
          <span class="hits">82</span>
          
          <code class="ruby">        entry[:oembed][&#39;unavailable&#39;] ? notify_unavailable(entry) : notify_available(entry)</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="36">
          <span class="hits">82</span>
          
          <code class="ruby">        entry.except(:source)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_collection(entries)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="41">
          <span class="hits">29</span>
          
          <code class="ruby">      parsed = []</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="42">
          <span class="hits">29</span>
          
          <code class="ruby">      entries.each_with_index do |entry, i|</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="43">
          <span class="hits">72</span>
          
          <code class="ruby">        entry = parse_item(entry)</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="44">
          <span class="hits">72</span>
          
          <code class="ruby">        parsed &lt;&lt; entry unless entry[:oembed][&#39;unavailable&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="46">
          <span class="hits">29</span>
          
          <code class="ruby">      parsed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_item(entry)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="50">
          <span class="hits">94</span>
          
          <code class="ruby">      parse_entry(entry)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_project(collections)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="54">
          <span class="hits">7</span>
          
          <code class="ruby">      collections</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_available(entry)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="58">
          <span class="hits">52</span>
          
          <code class="ruby">      entry[:source].notify_availability(entry, true) unless entry[:source].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    def notify_unavailable(entry)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="62">
          <span class="hits">30</span>
          
          <code class="ruby">      entry[:source].notify_availability(entry, false) unless entry[:source].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def alter_oembed(oembed, provider)</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="66">
          <span class="hits">67</span>
          
          <code class="ruby">      function = &quot;alter_#{provider}_oembed&quot;</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="67">
          <span class="hits">67</span>
          
          <code class="ruby">      oembed[&#39;unavailable&#39;] = true if oembed.respond_to?(:error_code) &amp;&amp; oembed.error_code === 404</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="68">
          <span class="hits">67</span>
          
          <code class="ruby">      (oembed = self.send(function, oembed)) if self.respond_to?(function)</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="69">
          <span class="hits">67</span>
          
          <code class="ruby">      oembed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    # Methods to alter responses for some providers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    def alter_twitter_oembed(oembed)</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="75">
          <span class="hits">44</span>
          
          <code class="ruby">      id = oembed[:link].match(/status\/([0-9]+)/)</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="76">
          <span class="hits">44</span>
          
          <code class="ruby">      unless id.nil?</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="77">
          <span class="hits">44</span>
          
          <code class="ruby">        Retryable.retryable tries: 5, sleep: 3 do</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="78">
          <span class="hits">44</span>
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="79">
          <span class="hits">44</span>
          
          <code class="ruby">            oembed = add_twitter_info(oembed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          rescue Twitter::Error::NotFound, Twitter::Error::Forbidden</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="81">
          <span class="hits">15</span>
          
          <code class="ruby">            oembed[&#39;unavailable&#39;] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">          rescue Twitter::Error::TooManyRequests =&gt; error</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">            sleep error.rate_limit.reset_in.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="87">
          <span class="hits">44</span>
          
          <code class="ruby">      oembed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_twitter_info(oembed)</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="91">
          <span class="hits">44</span>
          
          <code class="ruby">      id = oembed[:link].match(/status\/([0-9]+)/)</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="92">
          <span class="hits">44</span>
          
          <code class="ruby">      oembed[&#39;twitter_id&#39;] = id[1]</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="93">
          <span class="hits">44</span>
          
          <code class="ruby">      client = Twitter::REST::Client.new do |config|</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="94">
          <span class="hits">44</span>
          
          <code class="ruby">        config.consumer_key        = BRIDGE_CONFIG[&#39;twitter_consumer_key&#39;]</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="95">
          <span class="hits">44</span>
          
          <code class="ruby">        config.consumer_secret     = BRIDGE_CONFIG[&#39;twitter_consumer_secret&#39;]</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="96">
          <span class="hits">44</span>
          
          <code class="ruby">        config.access_token        = BRIDGE_CONFIG[&#39;twitter_access_token&#39;]</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="97">
          <span class="hits">44</span>
          
          <code class="ruby">        config.access_token_secret = BRIDGE_CONFIG[&#39;twitter_access_token_secret&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="44" data-linenumber="99">
          <span class="hits">44</span>
          
          <code class="ruby">      tweet = client.status(id[1])</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="100">
          <span class="hits">28</span>
          
          <code class="ruby">      oembed[&#39;coordinates&#39;] = [tweet.geo.latitude, tweet.geo.longitude] if tweet.geo?</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="101">
          <span class="hits">28</span>
          
          <code class="ruby">      oembed[&#39;created_at&#39;] = tweet.created_at</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="102">
          <span class="hits">28</span>
          
          <code class="ruby">      oembed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    def alter_instagram_oembed(oembed)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="106">
          <span class="hits">22</span>
          
          <code class="ruby">      uri = URI.parse(oembed[:link])</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="107">
          <span class="hits">22</span>
          
          <code class="ruby">      http = Net::HTTP.new(uri.host, uri.port)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="108">
          <span class="hits">22</span>
          
          <code class="ruby">      http.use_ssl = uri.scheme == &#39;https&#39;</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="109">
          <span class="hits">22</span>
          
          <code class="ruby">      result = http.get(uri.path)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="110">
          <span class="hits">22</span>
          
          <code class="ruby">      oembed[&#39;unavailable&#39;] = (result.code.to_i === 404)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="111">
          <span class="hits">22</span>
          
          <code class="ruby">      oembed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="355c824cd93e6e09a323c34f340a7ece563928ae">
  <div class="header">
    <h3>lib/bridge_error_codes.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bridge</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class ErrorCodes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    INVALID_SIGNATURE = 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    EXCEPTION = 2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    PARAMETERS_MISSING = 3</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    INVALID_TYPE = 4</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    NOT_FOUND = 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="68f4895821170a6fa9875b5ab313e46f4662bb99">
  <div class="header">
    <h3>lib/bridge_google_authentication.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>24</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bridge</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module GoogleAuthentication</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    def authenticate</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="5">
          <span class="hits">69</span>
          
          <code class="ruby">      return @session unless @session.nil?</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="6">
          <span class="hits">68</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="7">
          <span class="hits">68</span>
          
          <code class="ruby">        access_token = Rails.cache.fetch(&#39;!google_access_token&#39;) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">          generate_google_access_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="10">
          <span class="hits">68</span>
          
          <code class="ruby">        @session = GoogleDrive.login_with_oauth(access_token)</code>
        </li>
      
        <li class="covered" data-hits="68" data-linenumber="11">
          <span class="hits">68</span>
          
          <code class="ruby">        yield if block_given?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      rescue Google::APIClient::AuthorizationError</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">        access_token = generate_google_access_token</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">        Rails.cache.write(&#39;!google_access_token&#39;, access_token)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">        @session = GoogleDrive.login_with_oauth(access_token)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">        yield if block_given?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    def generate_google_access_token</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">      require &#39;google/api_client&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="24">
          <span class="hits">3</span>
          
          <code class="ruby">      require &#39;google/api_client/client_secrets&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="25">
          <span class="hits">3</span>
          
          <code class="ruby">      require &#39;google/api_client/auth/installed_app&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="27">
          <span class="hits">3</span>
          
          <code class="ruby">      client = Google::APIClient.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        :application_name =&gt; &#39;Bridgembed&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        :application_version =&gt; &#39;1.0.0&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="32">
          <span class="hits">3</span>
          
          <code class="ruby">      key = Google::APIClient::KeyUtils.load_from_pkcs12(@config[&#39;google_pkcs12_path&#39;], @config[&#39;google_pkcs12_secret&#39;])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="33">
          <span class="hits">3</span>
          
          <code class="ruby">      client.authorization = Signet::OAuth2::Client.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">          :token_credential_uri =&gt; &#39;https://accounts.google.com/o/oauth2/token&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          :audience =&gt; &#39;https://accounts.google.com/o/oauth2/token&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">          :scope =&gt; [&#39;https://www.googleapis.com/auth/drive&#39;, &#39;https://spreadsheets.google.com/feeds/&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          :issuer =&gt; @config[&#39;google_issuer&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          :signing_key =&gt; key)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="39">
          <span class="hits">3</span>
          
          <code class="ruby">      client.authorization.fetch_access_token!</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="40">
          <span class="hits">3</span>
          
          <code class="ruby">      client.authorization.access_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="208135f9268dfd1af0b59d06891ddbf351a93f59">
  <div class="header">
    <h3>lib/bridge_watchbot.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Bridge</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class Watchbot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">   </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(config = {})</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="5">
          <span class="hits">54</span>
          
          <code class="ruby">      @config = config</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="6">
          <span class="hits">54</span>
          
          <code class="ruby">      @url = @config[&#39;url&#39;]</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="7">
          <span class="hits">54</span>
          
          <code class="ruby">      @uri = URI.parse(@url) unless @url.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    def send(link)</code>
        </li>
      
        <li class="covered" data-hits="53" data-linenumber="11">
          <span class="hits">53</span>
          
          <code class="ruby">      response = nil</code>
        </li>
      
        <li class="covered" data-hits="53" data-linenumber="12">
          <span class="hits">53</span>
          
          <code class="ruby">      if @url.blank?</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="13">
          <span class="hits">52</span>
          
          <code class="ruby">        Rails.logger.info &#39;Not sending to WatchBot because its URL is not set on the configuration file&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">        response = self.request(link)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">        Rails.logger.info &#39;Sent to the WatchBot&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="53" data-linenumber="18">
          <span class="hits">53</span>
          
          <code class="ruby">      response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def request(link)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      request = Net::HTTP::Post.new(@uri.path)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      request.set_form_data({ url: link })</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      request[&#39;Authorization&#39;] = &#39;Token token=&#39; + @config[&#39;token&#39;].to_s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      http = Net::HTTP.new(@uri.hostname, @uri.port)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      http.use_ssl = @uri.scheme == &#39;https&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      http.request(request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
